<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¼ç‰©å°åŠ©æ‰‹ - ä»˜æ¬¾ç•Œé¢</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
    }
    #sketch-container { 
      display: none; 
      margin: 0 auto;
      max-width: 400px;
    }
    #sketch-container.active { 
      display: block; 
    }
    #loading {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 100;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #ff69b4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading"><div class="spinner"></div></div>
  <div id="sketch-container"></div>
  
  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1; // 1=æ”¶è´§ä¿¡æ¯, 2=æ”¯ä»˜æ–¹å¼, 3=å¯†ç è¾“å…¥, 4=æ”¯ä»˜å®Œæˆ
    let currentField = null;
    let userInfo = { name: "", phone: "", address: "" };
    let paymentMethods = [
      { name: "å¾®ä¿¡æ”¯ä»˜", icon: "ğŸ’³", desc: "æ¨èå¾®ä¿¡ç”¨æˆ·ä½¿ç”¨", selected: true, color: [76, 175, 80] },
      { name: "æ”¯ä»˜å®", icon: "ğŸ’°", desc: "å¿«é€Ÿå®‰å…¨æ”¯ä»˜", selected: false, color: [66, 165, 245] },
      { name: "ä¿¡ç”¨å¡", icon: "ğŸ›’", desc: "æ”¯æŒVisa/Master", selected: false, color: [255, 152, 0] },
      { name: "èŠ±å‘—åˆ†æœŸ", icon: "ğŸŒº", desc: "å¯åˆ†3/6/12æœŸ", selected: false, color: [236, 64, 122] },
      { name: "ç™½æ¡æ”¯ä»˜", icon: "ğŸ“", desc: "30å¤©å…æ¯", selected: false, color: [103, 58, 183] }
    ];
    let password = "";
    let digits = ["", "", "", "", "", ""];
    let paymentSuccess = false;
    let successStartFrame = 0;
    let selectedMethod = "å¾®ä¿¡æ”¯ä»˜";
    let orderNumber = "GD" + Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');

    // è·å–é€‰ä¸­çš„ç¤¼ç‰©ä»·æ ¼
    const selectedGiftPrice = localStorage.getItem('selectedGiftPrice');
    let giftPrice = selectedGiftPrice ? parseFloat(selectedGiftPrice) : 0.00;

    function setup() {
      let canvas = createCanvas(400, 700);
      canvas.parent('sketch-container');
      showPage(1); // é»˜è®¤æ˜¾ç¤ºç¬¬ä¸€é¡µ
      
      // éšè—åŠ è½½åŠ¨ç”»
      setTimeout(() => {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('sketch-container').classList.add('active');
      }, 1000);
    }

    function draw() {
      background(255, 245, 250); // æ›´æŸ”å’Œçš„ç²‰è‰²èƒŒæ™¯
      
      // ç»˜åˆ¶é¡¶éƒ¨è£…é¥°æ¡
      drawHeader();
      
      if (currentPage === 1) {
        drawShippingInfoPage();
      } else if (currentPage === 2) {
        drawPaymentMethodPage();
      } else if (currentPage === 3) {
        drawPasswordPage();
      } else if (currentPage === 4) {
        drawPaymentCompletePage();
      }
      
      // ç»˜åˆ¶åº•éƒ¨å¯¼èˆªæç¤º
      drawFooter();
    }

    function drawHeader() {
      // é¡¶éƒ¨è£…é¥°æ¡
      noStroke();
      fill(255, 105, 180);
      rect(0, 0, width, 10);
      
      // é¡µé¢æ ‡é¢˜
      fill(255, 105, 180);
      textSize(24);
      textAlign(CENTER);
      
      let title = "";
      if (currentPage === 1) title = "å¡«å†™æ”¶è´§ä¿¡æ¯";
      else if (currentPage === 2) title = "é€‰æ‹©æ”¯ä»˜æ–¹å¼";
      else if (currentPage === 3) title = "è¾“å…¥æ”¯ä»˜å¯†ç ";
      else if (currentPage === 4) title = "æ”¯ä»˜å®Œæˆ";
      
      text(title, width/2, 50);
      
      // ç¤¼ç‰©å›¾æ ‡
      textSize(30);
      text("ğŸ", width/2, 90);
    }

    function drawFooter() {
      // åº•éƒ¨å®‰å…¨æç¤º
      fill(150);
      textSize(12);
      textAlign(CENTER);
      text("å®‰å…¨æ”¯ä»˜ Â· ä¸ªäººä¿¡æ¯åŠ å¯†å¤„ç†", width/2, height - 20);
      
      // å½“å‰é¡µé¢æŒ‡ç¤ºå™¨
      for (let i = 1; i <= 4; i++) {
        fill(i === currentPage ? color(255, 105, 180) : color(200));
        ellipse(width/2 - 30 + i * 20, height - 40, 10, 10);
      }
    }

    // æ˜¾ç¤ºæŒ‡å®šé¡µé¢
    function showPage(pageNum) {
      currentPage = pageNum;
      resizeCanvas(400, 700);
      redraw();
    }

    // ç¬¬ä¸€é¡µ: æ”¶è´§ä¿¡æ¯
    function drawShippingInfoPage() {
      textAlign(LEFT);
      
      // è¡¨å•å­—æ®µ
      drawTextField("æ”¶ä»¶äººå§“å", userInfo.name, 50, 150, "name");
      drawTextField("æ‰‹æœºå·ç ", userInfo.phone, 50, 230, "phone");
      drawTextField("æ”¶è´§åœ°å€", userInfo.address, 50, 310, "address");
      
      // æäº¤æŒ‰é’®
      drawButton("ç¡®è®¤æ”¶è´§ä¿¡æ¯", 50, height - 120, width - 100, 50, 
                userInfo.name && userInfo.phone && userInfo.address);
    }

    function drawTextField(label, value, x, y, fieldName) {
      // æ ‡ç­¾
      fill(80);
      textSize(16);
      text(label + ":", x, y - 10);
      
      // è¾“å…¥æ¡†
      stroke(currentField === fieldName ? color(255, 105, 180) : color(220));
      strokeWeight(currentField === fieldName ? 2 : 1);
      fill(255);
      rect(x, y, width - 100, 50, 10);
      
      // æ–‡æœ¬
      fill(value ? 0 : 180);
      noStroke();
      text(value || "è¯·è¾“å…¥" + label, x + 15, y + 30);
    }

    // ç¬¬äºŒé¡µ: æ”¯ä»˜æ–¹å¼
    function drawPaymentMethodPage() {
      // é‡‘é¢æ˜¾ç¤º
      fill(255, 105, 180);
      textSize(18);
      textAlign(CENTER);
      text(`æ”¯ä»˜é‡‘é¢: Â¥${giftPrice.toFixed(2)}`, width/2, 120);
      
      // æ”¯ä»˜æ–¹å¼åˆ—è¡¨
      for (let i = 0; i < paymentMethods.length; i++) {
        let y = 160 + i * 90;
        let method = paymentMethods[i];
        
        // å¡ç‰‡èƒŒæ™¯
        fill(method.selected ? color(255, 230, 240) : 255);
        stroke(method.selected ? color(255, 105, 180) : color(220));
        strokeWeight(method.selected ? 2 : 1);
        rect(50, y, width - 100, 70, 15);
        
        // å›¾æ ‡
        textSize(28);
        text(method.icon, 70, y + 40);
        
        // æ”¯ä»˜æ–¹å¼åç§°
        fill(60);
        textSize(16);
        textAlign(LEFT);
        text(method.name, 110, y + 30);
        
        // æ”¯ä»˜æ–¹å¼æè¿°
        fill(120);
        textSize(12);
        text(method.desc, 110, y + 50);
        textAlign(CENTER);
        
        // å•é€‰æŒ‰é’®
        fill(method.selected ? color(255, 105, 180) : color(200));
        noStroke();
        ellipse(width - 70, y + 35, 24, 24);
        
        if (method.selected) {
          fill(255);
          ellipse(width - 70, y + 35, 10, 10);
          selectedMethod = method.name;
        }
      }
      
      // ç¡®è®¤æŒ‰é’®
      drawButton("ç¡®è®¤æ”¯ä»˜", 50, height - 120, width - 100, 50, true);
    }

    // ç¬¬ä¸‰é¡µ: å¯†ç è¾“å…¥
    function drawPasswordPage() {
      if (!paymentSuccess) {
        // æ”¯ä»˜ä¿¡æ¯
        fill(100);
        textSize(16);
        textAlign(CENTER);
        text(`æ”¯ä»˜æ–¹å¼: ${selectedMethod}`, width/2, 140);
        text(`é‡‘é¢: Â¥${giftPrice.toFixed(2)}`, width/2, 170);
        
        // å¯†ç è¾“å…¥æ¡†
        fill(255);
        stroke(200);
        rect(50, 200, width - 100, 60, 15);
        
        // å¯†ç åœ†ç‚¹
        for (let i = 0; i < 6; i++) {
          fill(digits[i] ? color(255, 105, 180) : color(200));
          noStroke();
          ellipse(100 + i * 40, 230, 16, 16);
        }
        
        // é”®ç›˜
        drawNumpad();
      } else {
        // æ”¯ä»˜å¤„ç†ä¸­åŠ¨ç”»
        fill(255, 105, 180);
        textSize(16);
        text("æ”¯ä»˜å¤„ç†ä¸­...", width/2, height - 150);
        
        // æ—‹è½¬åŠ¨ç”»
        push();
        translate(width/2, height/2);
        rotate(frameCount * 0.1);
        noFill();
        stroke(255, 105, 180);
        strokeWeight(3);
        ellipse(0, 0, 50, 50);
        pop();
        
        // 3ç§’åè·³è½¬åˆ°å®Œæˆé¡µé¢
        if (frameCount - successStartFrame > 180) {
          showPage(4);
        }
      }
    }

    function drawNumpad() {
      let startY = 300;
      let btnSize = 70;
      let spacing = 10;
      
      for (let row = 0; row < 4; row++) {
        for (let col = 0; col < 3; col++) {
          let x = 50 + col * (btnSize + spacing);
          let y = startY + row * (btnSize + spacing);
          
          // è·³è¿‡æœ€åä¸€è¡Œçš„ç¬¬2ä¸ªæŒ‰é’®(æ²¡æœ‰0)
          if (row === 3 && col === 1) continue;
          
          // æ£€æŸ¥é¼ æ ‡æ‚¬åœ
          let hover = mouseX > x && mouseX < x + btnSize && 
                     mouseY > y && mouseY < y + btnSize;
          
          // æŒ‰é’®èƒŒæ™¯
          fill(hover ? color(245) : 255);
          stroke(220);
          rect(x, y, btnSize, btnSize, 10);
          
          // æŒ‰é’®æ–‡æœ¬
          fill(60);
          textSize(24);
          textAlign(CENTER);
          if (row === 3 && col === 0) {
            text("0", x + btnSize/2, y + btnSize/2 + 8);
          } else if (row === 3 && col === 2) {
            textSize(20);
            text("âŒ«", x + btnSize/2, y + btnSize/2 + 8);
          } else {
            text(row * 3 + col + 1, x + btnSize/2, y + btnSize/2 + 8);
          }
        }
      }
    }

    // ç¬¬å››é¡µ: æ”¯ä»˜å®Œæˆ
    function drawPaymentCompletePage() {
      // å®Œæˆå›¾æ ‡
      fill(76, 175, 80);
      noStroke();
      ellipse(width/2, 180, 100, 100);
      fill(255);
      textSize(60);
      textAlign(CENTER);
      text("âœ“", width/2, 200);
      
      // å®Œæˆæ–‡å­—
      fill(255, 105, 180);
      textSize(24);
      text("æ”¯ä»˜æˆåŠŸ!", width/2, 280);
      
      // æ”¯ä»˜ä¿¡æ¯
      fill(100);
      textSize(16);
      text(`æ”¯ä»˜æ–¹å¼: ${selectedMethod}`, width/2, 320);
      text(`é‡‘é¢: Â¥${giftPrice.toFixed(2)}`, width/2, 350);
      text(`è®¢å•å·: ${orderNumber}`, width/2, 380);
      
      // ç¤¼ç‰©ä¿¡æ¯
      fill(255, 105, 180);
      textSize(20);
      text("ğŸ ç¥ç§˜ç¤¼ç‰© ğŸ", width/2, 430);
      fill(100);
      textSize(14);
      text("é¢„è®¡3-5ä¸ªå·¥ä½œæ—¥å†…é€è¾¾", width/2, 460);
      
      // å®ŒæˆæŒ‰é’®
      drawButton("å®Œæˆ", 150, height - 120, 100, 50, true);
      
      // 3ç§’åè‡ªåŠ¨è·³è½¬åˆ°å®Œæˆé¡µé¢
      if (frameCount - successStartFrame > 180) {
        // ä¿å­˜è®¢å•å·
        localStorage.setItem('orderNumber', orderNumber);
        // è·³è½¬åˆ°å®Œæˆé¡µé¢
        window.location.href = "complete.html";
      }
    }

    function drawButton(label, x, y, w, h, enabled) {
      let hover = enabled && mouseX > x && mouseX < x + w && 
                 mouseY > y && mouseY < y + h;
      
      fill(enabled ? (hover ? color(255, 85, 170) : color(255, 105, 180)) : color(200));
      noStroke();
      rect(x, y, w, h, 25);
      
      fill(255);
      textSize(18);
      textAlign(CENTER);
      text(label, x + w/2, y + h/2 + 8);
    }

    function mousePressed() {
      if (currentPage === 1) {
        // ç¬¬ä¸€é¡µé€»è¾‘ - æ”¶è´§ä¿¡æ¯
        if (mouseY > 150 && mouseY < 200) currentField = "name";
        else if (mouseY > 230 && mouseY < 280) currentField = "phone";
        else if (mouseY > 310 && mouseY < 360) currentField = "address";
        else currentField = null;
        
        // æ£€æŸ¥ç¡®è®¤æŒ‰é’®ç‚¹å‡»
        if (mouseX > 50 && mouseX < width - 50 && 
            mouseY > height - 120 && mouseY < height - 70 &&
            userInfo.name && userInfo.phone && userInfo.address) {
          // ä¿å­˜ç”¨æˆ·ä¿¡æ¯
          localStorage.setItem('userName', userInfo.name);
          showPage(2);
        }
      } 
      else if (currentPage === 2) {
        // ç¬¬äºŒé¡µé€»è¾‘ - æ”¯ä»˜æ–¹å¼é€‰æ‹©
        for (let i = 0; i < paymentMethods.length; i++) {
          let y = 160 + i * 90;
          if (mouseX > 50 && mouseX < width - 50 && mouseY > y && mouseY < y + 70) {
            paymentMethods.forEach(m => m.selected = false);
            paymentMethods[i].selected = true;
            selectedMethod = paymentMethods[i].name;
            redraw();
          }
        }
        
        // æ£€æŸ¥ç¡®è®¤æŒ‰é’®ç‚¹å‡»
        if (mouseX > 50 && mouseX < width - 50 && 
            mouseY > height - 120 && mouseY < height - 70) {
          showPage(3);
        }
      }
      else if (currentPage === 3 && !paymentSuccess) {
        // ç¬¬ä¸‰é¡µé€»è¾‘ - å¯†ç è¾“å…¥
        let startY = 300;
        let btnSize = 70;
        let spacing = 10;
        
        for (let row = 0; row < 4; row++) {
          for (let col = 0; col < 3; col++) {
            let x = 50 + col * (btnSize + spacing);
            let y = startY + row * (btnSize + spacing);
            
            // æ£€æŸ¥ç‚¹å‡»
            if (mouseX > x && mouseX < x + btnSize && 
                mouseY > y && mouseY < y + btnSize) {
              
              // æ•°å­—æŒ‰é’®
              if (row < 3 || (row === 3 && col === 0)) {
                if (password.length < 6) {
                  let num = row === 3 && col === 0 ? "0" : str(row * 3 + col + 1);
                  password += num;
                  digits[password.length - 1] = num;
                  
                  // æ¨¡æ‹Ÿæ”¯ä»˜éªŒè¯
                  if (password.length === 6) {
                    paymentSuccess = true;
                    successStartFrame = frameCount;
                    loop(); // å¼€å§‹åŠ¨ç”»
                  }
                }
              } 
              // é€€æ ¼æŒ‰é’®
              else if (row === 3 && col === 2 && password.length > 0) {
                password = password.slice(0, -1);
                digits[password.length] = "";
              }
              redraw();
            }
          }
        }
      }
      else if (currentPage === 4) {
        // ç¬¬å››é¡µé€»è¾‘ - å®ŒæˆæŒ‰é’®
        if (mouseX > 150 && mouseX < 250 && 
            mouseY > height - 120 && mouseY < height - 70) {
          // é‡ç½®æ”¯ä»˜æµç¨‹
          resetPayment();
          showPage(1);
        }
      }
    }

    function keyPressed() {
      if (currentPage === 1 && currentField) {
        if (keyCode === BACKSPACE) {
          userInfo[currentField] = userInfo[currentField].slice(0, -1);
        } else if (keyCode >= 32 && keyCode <= 126) { // å¯æ‰“å°å­—ç¬¦
          userInfo[currentField] += key;
        }
        redraw();
      }
    }

    function resetPayment() {
      password = "";
      digits = ["", "", "", "", "", ""];
      paymentSuccess = false;
      currentField = null;
    }
  </script>
</body>
</html>